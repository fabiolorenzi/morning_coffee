name: Build MorningCoffee

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build patchelf file wget curl git python3 python3-pip libglu1-mesa-dev mesa-utils

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.5.0
          host: linux
          target: desktop

      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH="$Qt6_DIR" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --parallel

      - name: Stage AppDir
        run: |
          mkdir -p build/AppDir/usr/bin
          mkdir -p build/AppDir/usr/share/applications
          mkdir -p build/AppDir/usr/share/icons/hicolor/64x64/apps

          # Copy binary
          cp build/MorningCoffee build/AppDir/usr/bin/MorningCoffee
          chmod +x build/AppDir/usr/bin/MorningCoffee

          # Copy icon
          cp assets/icons/icon.png build/AppDir/usr/share/icons/hicolor/64x64/apps/MorningCoffee.png

          # Create desktop file
          cat > build/AppDir/usr/share/applications/MorningCoffee.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=MorningCoffee
          Exec=MorningCoffee
          Icon=MorningCoffee
          Categories=Utility;
          EOF

      - name: Prepare AppImage metadata
        run: |
          cp build/AppDir/usr/share/applications/MorningCoffee.desktop build/AppDir/
          cp build/AppDir/usr/share/icons/hicolor/64x64/apps/MorningCoffee.png build/AppDir/

      - name: Download linuxdeploy and Qt plugin
        run: |
          mkdir -p build

          wget --tries=5 --retry-connrefused -O build/linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x build/linuxdeploy-x86_64.AppImage

          wget --tries=5 --retry-connrefused -O build/linuxdeploy-plugin-qt-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x build/linuxdeploy-plugin-qt-x86_64.AppImage

      - name: Bundle libraries and create AppImage
        run: |
          cd build

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            -d AppDir/MorningCoffee.desktop \
            -i AppDir/MorningCoffee.png \
            --plugin qt \
            --output appimage

          if [ -f MorningCoffee-x86_64.AppImage ]; then
            mv MorningCoffee-x86_64.AppImage MorningCoffee.AppImage
          else
            echo "ERROR: AppImage not found!"
            ls -l
            exit 1
          fi

      - name: Create release zip
        run: |
          cd build
          zip -j MorningCoffee-linux.zip MorningCoffee.AppImage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: MorningCoffee-linux
          path: build/MorningCoffee.AppImage

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.5.0
          host: windows
          target: desktop

      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH="%Qt6_DIR%"
          cmake --build . --config Release

      - name: Deploy Qt DLLs
        run: |
          windeployqt build/Release/MorningCoffee.exe --no-translations --release

      - uses: actions/upload-artifact@v4
        with:
          name: MorningCoffee-windows
          path: build/Release/*